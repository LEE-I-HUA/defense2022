---
title: "SBIR/STTR è£œåŠ©æ¡ˆè¶¨å‹¢åˆ†æ"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: default
    css: JH.css
    source_code: embed 
    logo: picture/mirdc48.png
    favicon: picture/mirdc48.png
runtime: shiny
---
```{r}
# å¥—ä»¶å€‘
pacman::p_load(dplyr,stringr,ggplot2,plotly,ggpubr,reshape2)
pacman::p_load(shinyWidgets,shiny,heatmaply,tidyr,DT,flexdashboard)

options(scipen=999) # ä¸è¦ç§‘å­¸è¨˜è™Ÿ
load('./data/SBIRdata.rdata') # loadè³‡æ–™

fill_color="#66B3FF" # é•·æ¢åœ–é¡è‰²
ctag = c('<font color="green"><b>', '<font color="red"><b>') # æ–‡ç« é—œéµå­—æ¨™è¨»é¡è‰²
chooseSliderSkin("Modern") # Sliderçš„style
```

åŸºæœ¬è³‡æ–™
======================================
Column {data-width=50%}
-------------------------------------
###  
```{r}
# å„éƒ¨é–€å€‹å¹´ä»½è£œåŠ©æ¡ˆç¸½ç­†æ•¸é•·æ¢åœ–
# ä»¥éƒ¨é–€å’Œå¹´ä»½ç‚ºç¾¤çµ„ï¼Œè¨ˆç®—æ¯ä¸€å¹´æ¯éƒ¨é–€çš„æ¯”æ•¸ï¼Œxè»¸ä»¥æ¯å€‹éƒ¨é–€çš„ç­†æ•¸åšæ’åºï¼Œä»¥ä¸åŒå¹´ä»½ä½œç‚ºé¡è‰²
ggplotly(
  sbir %>% group_by(Branch,Award.Year) %>% summarise(n = n()) %>% 
    ggplot(aes(x = reorder(Branch,n), y = n, fill = factor(Award.Year))) + 
    geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
    labs(x= NULL,y = NULL, title ='å„éƒ¨é–€è£œåŠ©æ¡ˆç¸½ç­†æ•¸') +
    guides(fill=guide_legend(title=NULL))+
    coord_flip()
)
```

###  
```{r}
# å„éƒ¨é–€å€‹å¹´ä»½è£œåŠ©æ¡ˆç¸½é‡‘é¡é•·æ¢åœ–(ä»¥è¬ç‚ºå–®ä½)
# ä»¥éƒ¨é–€å’Œå¹´ä»½ç‚ºç¾¤çµ„ï¼Œè¨ˆç®—æ¯ä¸€å¹´æ¯éƒ¨é–€çš„ç¸½é‡‘é¡ä¸¦ä»¥è¬ç‚ºå–®ä½é™¤ä»¥1000ï¼Œxè»¸ä»¥æ¯å€‹éƒ¨é–€çš„ç­†æ•¸åšæ’åºï¼Œä»¥ä¸åŒå¹´ä»½ä½œç‚ºé¡è‰²
ggplotly(
  sbir %>% group_by(Branch,Award.Year) %>% 
    summarise(totalmoney = sum(Award.Amount)/10000,n = n()) %>% 
    ggplot(aes(x = reorder(Branch,n), y = totalmoney, fill = factor(Award.Year))) + 
    geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
    labs(x= NULL,y = NULL, title ='å„éƒ¨é–€ç¸½è£œåŠ©é‡‘é¡(è¬å…ƒ)') +
    guides(fill=guide_legend(title=NULL))+
    coord_flip()
)
```


Column {data-width=50%}
-------------------------------------
###  
```{r}
# å„éƒ¨é–€å€‹å¹´ä»½è£œåŠ©æ¡ˆå¹³å‡æ¯ç­†è£œåŠ©æ¡ˆé‡‘é¡é•·æ¢åœ–(ä»¥è¬ç‚ºå–®ä½)
# ä»¥éƒ¨é–€å’Œå¹´ä»½ç‚ºç¾¤çµ„ï¼Œè¨ˆç®—æ¯ä¸€å¹´æ¯éƒ¨é–€çš„å¹³å‡é‡‘é¡(é™¤ä»¥ç­†æ•¸n)ä¸¦ä»¥è¬ç‚ºå–®ä½é™¤ä»¥1000ï¼Œxè»¸ä»¥æ¯å€‹éƒ¨é–€çš„ç­†æ•¸åšæ’åºï¼Œä»¥ä¸åŒå¹´ä»½ä½œç‚ºé¡è‰²
ggplotly(
  sbir %>% group_by(Branch,Award.Year) %>% 
    summarise(n = n(), averagemoney = sum(Award.Amount)/10000/n) %>% 
    ggplot(aes(x = reorder(Branch,n), y = averagemoney, fill = factor(Award.Year))) + 
    geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
    labs(x= NULL,y = NULL, title ='å„éƒ¨é–€å¹³å‡æ¯ç­†è£œåŠ©æ¡ˆé‡‘é¡(è¬å…ƒ)') +
    guides(fill=guide_legend(title=NULL))+
    coord_flip()
)
```

###  
```{r}
# èª¿æ•´é¡¯ç¤ºå‰å¹¾åçš„æ¨™ç±¤çš„æ‹‰éœ¸ï¼Œé½’è¼ªå¤§å°(xs)ã€‚sliderInput
dropdownButton(
  size = "xs",status = 'danger',icon = icon("gear"),
  sliderInput("tagRank", label = "é¡¯ç¤ºå‰å¹¾åçš„æ¨™ç±¤", min = 0,
        max = 100,5, value = c(0, 20))
)
renderPlotly({
  # æ¨™ç±¤å‡ºç¾çš„ç¸½æ¬¡æ•¸
  ggplotly(
    sbirTags %>% group_by(tag) %>% summarise(n = n()) %>% arrange(desc(n)) %>%
        slice(input$tagRank[1]:input$tagRank[2]) %>%
        ggplot(aes(x = reorder(tag,n), y = n)) +
        geom_bar(stat="identity",fill=fill_color) +
        labs(x= NULL,y = NULL, title =paste0('ç¬¬',input$tagRank[1],'åˆ°',input$tagRank[2],'åæ¨™ç±¤å‡ºç¾çš„ç¸½æ¬¡æ•¸')) +
        guides(fill=guide_legend(title=NULL))+
        coord_flip()
    # +geom_text(mapping = aes(label = n),
    #           size = 3, colour = 'black', vjust = 0.5,nudge_y = 15)
  )
  })
```


è©é »è¡¨{data-orientation=columns}
======================================

Column input {data-width=24%}
-------------------------------------
###
```{r}
h4("å…¨éƒ¨è£œåŠ©æ¡ˆè©é »è¡¨è¨­å®š(å·¦åœ–)")
h6('ğŸ“¢é€éè£œåŠ©æ¡ˆçš„TF-IDFè©é »è¡¨å¯ä»¥æŸ¥çœ‹åœ¨æ‰€æœ‰è£œåŠ©æ¡ˆä¸­è¼ƒç‚ºé‡è¦çš„å­—è©ï¼Œä¸¦æ‰¾å°‹æœªåœ¨å­—å…¸ä¸­çš„é‡è¦å­—è©')
sliderInput("tfidf",  "è¨­å®šTF-IDFé–€æª»(ç™¾åˆ†ä½æ•¸)",  0, 100, 75, 25)
sliderInput("freq",  "è¨­å®šè©é »é–€æª»",  0, 1000, 100, 100)
h5('â“TF-IDFè§£é‡‹ï¼š')
h6('* TFï¼šTerm Frequency è©é »')
h6('* IDFï¼šInverse Document Frequency é€†å‘æª”æ¡ˆé »ç‡')
h6('* TF-IDFæ•´é«”æ„ç¾©ï¼šè¨ˆç®—å‡ºèª°æ˜¯ç›¸å°æ¯”è¼ƒé‡è¦çš„å­—è©ï¼Œå­—è©çš„é‡è¦æ€§éš¨è‘—åœ¨ä¸€ç¯‡è£œåŠ©æ¡ˆä¸­å‡ºç¾çš„é »ç‡è¶Šé«˜å‰‡è¶Šé«˜ï¼›åœ¨ä¸åŒè£œåŠ©æ¡ˆä¸­å‡ºç¾æ¬¡æ•¸è¶Šé«˜åè€Œä»£è¡¨è¶Šå¸¸è¦‹çš„å­—ä¸”è¶Šä¸é‡è¦ã€‚')
h6('ä¸€èˆ¬è€Œè¨€TF-IDFçš„æ•¸å€¼ä¸¦ä¸å…·æœ‰ç‰¹åˆ¥æ„ç¾©ï¼Œé€šå¸¸æœƒé€éèª¿æ•´ç™¾åˆ†æ¯”èˆ‡é »ç‡çš„é–€æª»ä¾†ç¯©é¸å‡ºTF-IDFç›¸å°é«˜ä¸”é »ç‡é«˜çš„é‡è¦è©å½™')
br()
hr() # åˆ†éš”ç·š
h4("é—œéµå­—å­—å…¸è¨­å®š(å³åœ–)")
h6('é€éé—œéµå­—å­—å…¸çš„è©é »è¡¨å¯ä»¥æŸ¥çœ‹å„é—œéµå­—é¡åˆ¥ä¸­é »ç‡è¼ƒé«˜çš„è©')
pickerInput(
    inputId="kwClass", label = "é¸æ“‡é—œéµå­—é¡åˆ¥", choices = unique(dict$class),
    options = list(style="btn-success"),
    selected = unique(dict$class), multiple=T)

# input = list("freq" = 100, "tfidf" = 75)

```


Column {data-width=38%}
-------------------------------------
### 
```{r }
# TF-IDFè©é »è¡¨
renderPlotly({ 
  word_tfidf %>% filter(freq >= input$freq) %>% 
    filter(tf_idf > quantile(word_tfidf$tf_idf,input$tfidf/100)) %>% 
    arrange(desc(freq)) %>% head(20) %>% 
    ggplot(aes(x = reorder(term,freq), y = freq)) + 
    geom_bar(stat="identity",fill=fill_color) +
    labs(x= NULL,y = "è©é »", title = paste0('é »ç‡å¤§æ–¼',input$freq,'ä¸”TF-IDFå¤§æ–¼',input$tfidf,'%è©é »')) +
    guides(fill=guide_legend(title=NULL))+
    coord_flip()
  
})
```


Column {data-width=38%}
-------------------------------------
### 
```{r}
# é—œéµå­—å­—å…¸è©é »è¡¨
renderPlotly({ 
    dict %>% filter(class %in% input$kwClass) %>% arrange(desc(freq)) %>% head(20) %>% 
        ggplot(aes(x = reorder(entity,freq), y = freq,fill=class)) +
        geom_bar(stat="identity") +
        labs(x= NULL,y = NULL, title ='é—œéµå­—å­—å…¸è©é »è¡¨') +
        guides(fill=guide_legend(title=NULL))+
        coord_flip()
  })
```

é—œéµå­—çµ±è¨ˆ
======================================

Column {data-width=24%}
-------------------------------------
### 
```{r}
h5('ï¼Šä½¿ç”¨èªªæ˜ï¼š')
h6('é¸æ“‡åœ¨å„å€‹é¡åˆ¥ä¸­é—œæ³¨çš„é—œéµå­—ï¼Œé€éçµ±è¨ˆåœ–è¡¨å¯ä»¥å¾—çŸ¥æ‰€é—œæ³¨çš„é—œéµå­—åœ¨é »ç‡ã€è£œåŠ©æ¡ˆç­†æ•¸ã€é‡‘é¡ï¼Œå¹³å‡é‡‘é¡ä¸Šçš„å·®ç•°')
h6('ï¼Šæ­¤åˆ†é æŒ‘é¸å®Œçš„é—œéµå­—å°‡æœƒåœ¨å¾ŒçºŒå…©å€‹åˆ†é é€²è¡ŒBranchå’Œå…¬å¸çš„äº¤å‰åˆ†æ')

pickerInput(
    inputId="class", label = "é¸æ“‡é—œéµå­—é¡åˆ¥", choices = unique(dict$class),
    options = list(style="btn-success"),
    selected = "æ ¸å¿ƒé—œéµå­—")

pickerInput(
    inputId="kw", label = "é¸æ“‡é—œéµå­—", choices = dict$entity[dict$class == "æ ¸å¿ƒé—œéµå­—"],
    options = pickerOptions(style="btn-success",liveSearch=T),
    selected = dict$entity[dict$class == "æ ¸å¿ƒé—œéµå­—"][1:5], multiple=T)

observeEvent(input$class,{
  updatePickerInput(session, "kw",
                    choices = dict$entity[dict$class == input$class],
                    selected = dict$entity[dict$class == input$class][1:5])
})
# input = list("class" = "æ ¸å¿ƒé—œéµå­—","kw" = dict$entity[dict$class == "æ ¸å¿ƒé—œéµå­—"][1:5])
```


Column {data-width=38%}
-------------------------------------
###
```{r}
# é—œéµå­—å‡ºç¾çš„ç¸½æ¬¡æ•¸
renderPlotly({
  kwdocDF %>% filter(entity %in% input$kw) %>% group_by(entity,doc_freq) %>% summarise(n = sum(word_freq)) %>% 
  ggplot(aes(x = reorder(entity,doc_freq), y = n)) + 
  geom_bar(position = position_dodge2(reverse = TRUE),stat="identity",fill = fill_color) +
  labs(x= NULL,y = "æ¬¡æ•¸", title = 'é—œéµå­—å‡ºç¾çš„ç¸½æ¬¡æ•¸') +
  coord_flip()->g
ggplotly(g)

})
```

###
```{r}
# é—œéµå­—è£œåŠ©æ¡ˆç­†æ•¸
renderPlotly({
  kwdocDF %>% filter(entity %in% input$kw) %>% group_by(Award.Year,entity,doc_freq) %>% summarise(n = sum(metion)) %>%  
  ggplot(aes(x = reorder(entity,doc_freq), y = n, fill = factor(Award.Year))) + 
  geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
  labs(x= NULL,y = "ç­†æ•¸", title = paste0(input$class,'ä¸­å„é—œéµå­—è£œåŠ©æ¡ˆç­†æ•¸')) +
  guides(fill=guide_legend(title=NULL))+
  coord_flip()->g
ggplotly(g)

})
```



Column {data-width=38%}
-------------------------------------
###
```{r}
# é—œéµå­—è£œåŠ©æ¡ˆç¸½é«”é‡‘é¡
renderPlotly({
  kwdocDF %>% filter(entity %in% input$kw) %>% filter(metion == TRUE) %>% 
  group_by(Award.Year, entity, doc_freq) %>% summarise(money = sum(Award.Amount)) %>% 
  ggplot(aes(x = reorder(entity,doc_freq), y = money/10000, fill = factor(Award.Year))) + 
  geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
  labs(x= NULL,y = "é‡‘é¡(è¬å…ƒ)", title = paste0(input$class,'ä¸­å„é—œéµå­—ç¸½é«”é‡‘é¡')) +
  guides(fill=guide_legend(title=NULL))+
  coord_flip()->g
ggplotly(g)

})
```

###
```{r}
# é—œéµå­—è£œåŠ©æ¡ˆå¹³å‡é‡‘é¡
renderPlotly({
  kwdocDF %>% filter(entity %in% input$kw) %>% filter(metion == TRUE) %>% 
  group_by(Award.Year, entity, doc_freq) %>% summarise(money = sum(Award.Amount), n = n()) %>% 
  ggplot(aes(x = reorder(entity,doc_freq), y = money/n/10000, fill = factor(Award.Year))) + 
  geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
  labs(x= NULL,y = "é‡‘é¡(è¬å…ƒ)", title = paste0(input$class,'ä¸­å„é—œéµå­—å¹³å‡é‡‘é¡')) +
  guides(fill=guide_legend(title=NULL))+
  coord_flip()->g
ggplotly(g)

})
```

éƒ¨é–€èˆ‡é—œéµå­—
======================================


Column {data-width=50%}
-------------------------------------
### 2020å¹´é—œéµå­—èˆ‡Branchçš„äº¤å‰åˆ†æ
```{r}
# branchåˆ—è¡¨
BranchList = sbir %>% group_by(Branch) %>% summarise(n=n()) %>% arrange(desc(n))

dropdown(
  h6('ï¼Šå°‡ä¸Šä¸€å€‹åˆ†é æ‰€é¸ä¹‹é—œéµå­—èˆ‡Branché€²è¡Œäº¤å‰åˆ†æï¼Œä¸¦æ ¹æ“šä¸åŒçš„æ¨™æº–åŒ–æ–¹å‘å¾—åˆ°ä¸åŒçš„åˆ†æçµæœ'),
  h6('é€é2020å¹´èˆ‡2021å¹´å…©å¹´çš„æ¯”è¼ƒï¼Œä¹Ÿèƒ½åˆ†æå„é—œéµå­—åœ¨Branché–“çš„è®ŠåŒ–'),
  pickerInput(
    inputId="branch", label = "é¸æ“‡Branch", choices = BranchList$Branch,
    options = list(`live-search`=T,style="btn-success"),
    selected = BranchList$Branch[1:5], multiple=T),
  pickerInput(
    inputId="scaler", label = "é¸æ“‡æ¨™æº–åŒ–æ–¹å‘", choices = c("ä¸æ¨™æº–åŒ–","Branchæ–¹å‘","é—œéµå­—æ–¹å‘"),
    options = list(style="btn-success"),
    selected = "ä¸æ¨™æº–åŒ–"),
  h6("ä¸æ¨™æº–åŒ–ï¼šé¡¯ç¤ºåŸå§‹ç­†æ•¸"),
  h6("Branchæ–¹å‘ï¼šé€™å€‹Branchæ¯”è¼ƒå¸¸æåˆ°å“ªå€‹é—œéµå­—"),
  h6("é—œéµå­—æ–¹å‘ï¼šé€™å€‹é—œéµå­—æ¯”è¼ƒå¸¸è¢«å“ªå€‹Branchæåˆ°")
# input = list("class" = "æ ¸å¿ƒé—œéµå­—","kw" = dict$entity[dict$class == "æ ¸å¿ƒé—œéµå­—"][1:5], "branch" = BranchList$Branch[1:5],"scaler"="ä¸æ¨™æº–åŒ–")
)

# 2020ç†±åœ–
renderPlotly({
  # æŒ‘é¸å‡ºè¨­å®šçš„é—œéµå­—å’Œbranchçš„2020å¹´è³‡æ–™ï¼Œè¨ˆç®—ç­†æ•¸
  DF = kwdocDF %>% 
    filter(entity %in% input$kw) %>% 
    filter(Branch %in% input$branch) %>% 
    filter(Award.Year == 2020) %>% 
    group_by(Branch,entity) %>% 
    summarise(n= sum(metion)) %>% ungroup()
  # spreadæˆç†±åœ–çš„è³‡æ–™å‹æ…‹
  DF = DF %>% spread(Branch,n, fill=0) %>% as.data.frame()
  rownames(DF)<- DF$entity
  # heatmaply(DF[,-1],colors=c("white","khaki","darkorange","chocolate"), scale="row")
  
  # æ ¹æ“šé¸æ“‡èª¿æ•´ä¸åŒçš„æ¨™æº–åŒ–æ–¹å‘
  if(input$scaler =="Branchæ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "column",Rowv = FALSE,Colv = FALSE)
  }
  else if(input$scaler =="é—œéµå­—æ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "row",Rowv = FALSE,Colv = FALSE)
  }
  else{
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),Rowv = FALSE,Colv = FALSE)
  }
  
})
```


Column {data-width=50%}
-------------------------------------
### 2021å¹´é—œéµå­—èˆ‡Branchçš„äº¤å‰åˆ†æ
```{r}
renderPlotly({
  DF = kwdocDF %>% 
    filter(entity %in% input$kw) %>% 
    filter(Branch %in% input$branch) %>% 
    filter(Award.Year == 2021) %>% 
    group_by(Branch,entity) %>% 
    summarise(n= sum(metion)) %>% ungroup()
  
  DF = DF %>% spread(Branch,n, fill=0) %>% as.data.frame()
  rownames(DF)<- DF$entity
  if(input$scaler =="Branchæ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "column",Rowv = FALSE,Colv = FALSE)
  }
  else if(input$scaler =="é—œéµå­—æ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "row",Rowv = FALSE,Colv = FALSE)
  }
  else{
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),Rowv = FALSE,Colv = FALSE)
  }
  })
```


å…¬å¸èˆ‡é—œéµå­—
======================================

Column {data-width=50%}
-------------------------------------
### 2020å¹´é—œéµå­—èˆ‡å…¬å¸çš„äº¤å‰åˆ†æ
```{r}
CompanyList = sbir %>% group_by(Company) %>% summarise(n=n()) %>% arrange(desc(n))
dropdown(
   h6('ï¼Šå°‡ä¸Šä¸€å€‹åˆ†é æ‰€é¸ä¹‹é—œéµå­—èˆ‡å…¬å¸é€²è¡Œäº¤å‰åˆ†æï¼Œä¸¦æ ¹æ“šä¸åŒçš„æ¨™æº–åŒ–æ–¹å‘å¾—åˆ°ä¸åŒçš„åˆ†æçµæœ'),
  h6('é€é2020å¹´èˆ‡2021å¹´å…©å¹´çš„æ¯”è¼ƒï¼Œä¹Ÿèƒ½åˆ†æå„é—œéµå­—åœ¨å…¬å¸é–“çš„è®ŠåŒ–'), pickerInput(
    inputId="company", label = "é¸æ“‡å…¬å¸", choices = CompanyList$Company,
    options = list(`live-search`=T, style="btn-success"),
    selected = CompanyList$Company[1:5], multiple=T),
  pickerInput(
    inputId="scaler2", label = "é¸æ“‡æ¨™æº–åŒ–æ–¹å‘", choices = c("ä¸æ¨™æº–åŒ–","å…¬å¸æ–¹å‘","é—œéµå­—æ–¹å‘"),
    options = list(style="btn-success"),
    selected = "ä¸æ¨™æº–åŒ–"),
  h6("ä¸æ¨™æº–åŒ–ï¼šé¡¯ç¤ºåŸå§‹ç­†æ•¸"),
  h6("å…¬å¸æ–¹å‘ï¼šé€™å€‹å…¬å¸æ¯”è¼ƒå¸¸æåˆ°å“ªå€‹é—œéµå­—"),
  h6("é—œéµå­—æ–¹å‘ï¼šé€™å€‹é—œéµå­—æ¯”è¼ƒå¸¸è¢«å“ªå€‹å…¬å¸æåˆ°")
# input = list("class" = "å­¸ç ”å–®ä½","kw" = dict$entity[dict$class == "å­¸ç ”å–®ä½"][1:5], "branch" = BranchList$Branch[1:5], "company" = CompanyList$Company[1:5])
)

renderPlotly({
  DF = kwdocDF %>% 
    filter(entity %in% input$kw) %>% 
    filter(Company %in% input$company) %>% 
    filter(Award.Year == 2020) %>% 
    group_by(Company,entity) %>% 
    summarise(n= sum(metion)) %>% ungroup()
  
  DF = DF %>% spread(Company,n, fill=0) %>% as.data.frame()
  rownames(DF)<- DF$entity
  if(input$scaler2 =="å…¬å¸æ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "column",Rowv = FALSE,Colv = FALSE)
  }
  else if(input$scaler2 =="é—œéµå­—æ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "row",Rowv = FALSE,Colv = FALSE)
  }
  else{
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),Rowv = FALSE,Colv = FALSE)
  }

})
```


Column {data-width=50%}
-------------------------------------
### 2021å¹´é—œéµå­—èˆ‡å…¬å¸çš„äº¤å‰åˆ†æ
```{r}
renderPlotly({
  DF = kwdocDF %>% 
    filter(entity %in% input$kw) %>% 
    filter(Company %in% input$company) %>% 
    filter(Award.Year == 2021) %>% 
    group_by(Company,entity) %>% 
    summarise(n= sum(metion)) %>% ungroup()
  
  DF = DF %>% spread(Company,n, fill=0) %>% as.data.frame()
  rownames(DF)<- DF$entity
  if(input$scaler2 =="å…¬å¸æ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "column",Rowv = FALSE,Colv = FALSE)
  }
  else if(input$scaler2 =="é—œéµå­—æ–¹å‘"){
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),scale = "row",Rowv = FALSE,Colv = FALSE)
  }
  else{
    heatmaply(DF[,-1],colors=c("white","lightblue","dodgerblue","midnightblue"),Rowv = FALSE,Colv = FALSE)
  }

})
```


é—œæ³¨å­—è©{data-orientation=columns}
======================================

Column input {data-width=22%}
-------------------------------------
### 
```{r}
h5('ï¼Šä½¿ç”¨èªªæ˜ï¼š')
h6('æ ¹æ“šå‰é¢çš„åˆ†æå¯ä»¥æ‰¾å‡ºç›¸å°é—œæ³¨çš„é—œéµå­—æˆ–ä¸€èˆ¬å­—è©ï¼Œé€éæ­¤åˆ†é å¯ä»¥æŒ‘é¸é—œéµå­—æˆ–è‡ªè¡Œè¼¸å…¥ä¸€èˆ¬å­—è©ï¼Œä¾†é¡¯ç¤ºå‡ºé€™äº›é—œæ³¨è©çš„çµ±è¨ˆè³‡è¨Š')
h6('ï¼Šè‹¥è‡ªè¨‚é—œéµå­—ä¸ç‚ºç©ºå‰‡æœå°‹è‡ªè¨‚é—œéµå­—')
h6('ï¼Šæœå°‹å·²çŸ¥é—œéµå­—å‰‡è«‹å…ˆæ¸…ç©ºè‡ªè¨‚é—œéµå­—å†æŒ‰é–‹å§‹æœå°‹')
h6('ï¼Šé¸é—œéµå­—æˆ–è¼¸å…¥è‡ªè¨‚é—œéµå­—å¾Œï¼Œè«‹é»é¸é–‹å§‹æœå°‹')

pickerInput(
    inputId="class2", label = "é¸æ“‡é—œéµå­—é¡åˆ¥", choices = unique(dict$class),
    options = list(style="btn-success"),
    selected = "æ ¸å¿ƒé—œéµå­—")

pickerInput(
    inputId="kw2", label = "é¸æ“‡é—œéµå­—", choices = dict$entity[dict$class == "æ ¸å¿ƒé—œéµå­—"],
    options = list(`live-search`=T,style="btn-success"),
    selected = dict$entity[dict$class == "æ ¸å¿ƒé—œéµå­—"][1])

# æ ¹æ“šclass2èª¿æ•´pickerInputï¼škw2çš„è¼¸å‡º
observeEvent(input$class2,{
  updatePickerInput(session, "kw2",
                    choices = dict$entity[dict$class == input$class2],
                    selected = dict$entity[dict$class == input$class2][1])
})

textInput("pattern2","è¼¸å…¥è‡ªè¨‚é—œéµå­—","")
hr()
actionButton("go","é–‹å§‹æœå°‹")

h6('ï¼Šã€æåˆ°é—œéµå­—å„éƒ¨é–€è£œåŠ©æ¡ˆç­†æ•¸ã€çµ±è¨ˆåœ–(å·¦ä¸Š)ä¸Šé»é¸é—œæ³¨çš„Branchï¼Œå‰‡æ­¤Branchæåˆ°æ­¤é—œéµå­—çš„è£œåŠ©æ¡ˆè³‡è¨Šå°‡æœƒé¡¯ç¤ºæ–¼ä¸‹ä¸€å€‹ã€highlightæ–‡ç« ã€çš„åˆ†é ä¸­')
hr()
h5('ï¼Šæ­£è¦è¡¨é”å¼ Hint')
h6('è‹¥è¦æœå°‹ã€Œä¸é€£å­—ã€çš„ç‰¹å®šå­—è©å¯åœ¨æ­¤å­—è©å‰å¾ŒåŠ \\bï¼Œèˆ‰ä¾‹ï¼šè‹¥æœå°‹ARå¯èƒ½æœƒæœå°‹åˆ°æåˆ°ARMã€SARç­‰æ–‡ç« ')
h6('å› çˆ²SARã€ARMåŒ…å«ARé€™å€‹å­—è©ï¼Œæ•…æœå°‹ç¸®å¯«æ™‚å»ºè­°åœ¨é—œéµå­—å‰å¾ŒåŠ ä¸Š\\bä»¥å…æœå°‹åˆ°ç„¡é—œæ–‡ç« ')
# input$goçš„æŒ‰éˆ•æœƒç™¼ç”Ÿçš„event
EX = eventReactive(input$go, {
  # input=list(pattern1="AR/VR",pattern2="")
  pat=input$pattern2
  alias=ifelse(pat=="",dict$alias[dict$entity==input$kw2],pat)
  keyword = ifelse(input$pattern2=="",input$kw2,input$pattern2)
  kwDF = sbir[str_detect(sbir$Abstract,alias),]
  list(alias=alias,keyword=keyword,kwDF=kwDF)
})
# input = list("pattern2"="","kw"='5G')
```


Column {data-width=39%}
-------------------------------------
### {data-height=50%}
```{r }
renderPlotly({
  # å¾EXæ‹¿åˆ°å›å‚³çš„è³‡æ–™
  alias=EX()$alias
  keyword=EX()$keyword
  kwDF = EX()$kwDF

  # ç”¢ç”Ÿå€‹éƒ¨é–€çš„ç¸½ç­†æ•¸
  kwDF = kwDF %>% group_by(Branch) %>%
    summarise(n = n()) %>% arrange(desc(n)) %>% head(10)
  # è¨­å®šhighlightæ™‚å›å‚³çš„keyåç¨±
    kwBranch <- highlight_key(kwDF, ~Branch)
  
    ggplotly(
      ggplot(kwBranch) +
      geom_bar(aes(x = reorder(Branch,n), y = n),stat="identity",fill=fill_color) +
      labs(x= NULL,y = "ç­†æ•¸", title = 'æåˆ°é—œéµå­—å„éƒ¨é–€è£œåŠ©æ¡ˆç­†æ•¸') +
      guides(fill=guide_legend(title=NULL))+
      scale_x_discrete(labels = function(x) str_wrap(x, width = 40)) +
      coord_flip()
    ) %>% highlight(on = "plotly_click",off = "plotly_doubleclick")
    # è¨­å®šhighlightçš„äº‹ä»¶æ˜¯plotly_clickå–æ¶ˆçš„æ–¹å¼æ˜¯plotly_doubleclick
  
})
```


### {data-height=50%}
```{r}
renderPlotly({
  alias=EX()$alias
  keyword=EX()$keyword
  kwDF = EX()$kwDF
  # æåˆ°é—œéµå­—è£œåŠ©æ¡ˆå‰10å¤šæ¨™ç±¤
  merge(kwDF, sbirTags, by='doc_id') %>% 
    group_by(tag) %>% summarise(n = n()) %>% arrange(desc(n)) %>% head(10) %>% 
    ggplot(aes(x = reorder(tag,n), y = n)) + 
    geom_bar(stat="identity",fill = fill_color) +
    labs(x= NULL,y = "ç­†æ•¸", title ='æåˆ°é—œéµå­—è£œåŠ©æ¡ˆå‰10å¤šæ¨™ç±¤') +
    guides(fill=guide_legend(title=NULL))+
    scale_x_discrete(labels = function(x) str_wrap(x, width = 40)) +
    coord_flip()
  
})


```


Column {data-width=39%}
-------------------------------------
###  {data-height=50%}
```{r }
renderPlotly({
  alias=EX()$alias
  keyword=EX()$keyword
  kwDF = EX()$kwDF
# æåˆ°é—œéµå­—å„éƒ¨é–€è£œåŠ©æ¡ˆé‡‘é¡
  kwDF %>% group_by(Branch,Award.Year) %>% 
    summarise(n = n(),totalmoney = sum(Award.Amount)/10000) %>% arrange(desc(n)) %>% head(10) %>% 
    ggplot(aes(x = reorder(Branch,n), y = totalmoney, fill = factor(Award.Year))) + 
    geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
    labs(x= NULL,y = "é‡‘é¡(è¬å…ƒ)", title = 'æåˆ°é—œéµå­—å„éƒ¨é–€è£œåŠ©æ¡ˆé‡‘é¡') +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 40)) +
    guides(fill=guide_legend(title=NULL))+
    coord_flip()
})
```

###  {data-height=50%}
```{r}
renderPlotly({
  alias=EX()$alias
  keyword=EX()$keyword
  kwDF = EX()$kwDF
# æåˆ°é—œéµå­—å„éƒ¨é–€å¹³å‡æ¯ç­†è£œåŠ©æ¡ˆé‡‘é¡
  kwDF %>% group_by(Branch,Award.Year) %>% 
    summarise(n = n(),averagemoney = sum(Award.Amount)/10000/n) %>% arrange(desc(n)) %>% head(10) %>% 
    ggplot(aes(x = reorder(Branch,n), y = averagemoney, fill = factor(Award.Year))) + 
    geom_bar(position = position_dodge2(reverse = TRUE),stat="identity") +
    labs(x= NULL,y = "é‡‘é¡(è¬å…ƒ)", title = 'æåˆ°é—œéµå­—å„éƒ¨é–€å¹³å‡æ¯ç­†è£œåŠ©æ¡ˆé‡‘é¡') +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 40)) +
    guides(fill=guide_legend(title=NULL))+
    coord_flip()
})
```



highlightæ–‡ç« {data-orientation=columns}
==========================================

Column {data-width=50%}
-------------------------------------
###
```{r}
# å¾plotly_clickçš„äº‹ä»¶å–å¾—è³‡æ–™ï¼Œæ‹¿æ‰key(ä»£è¡¨é»åˆ°å“ªä¸€å€‹branch)
branch_reactive = eventReactive(event_data("plotly_click"), {
  b = event_data("plotly_click")$key
  list(b = b)
})

uiOutput("dynamic")
# è¨­å®šè¦å›å‚³çš„å‹æ…‹æ˜¯dataTableOutput
output$dynamic <- renderUI({ dataTableOutput("myTable") })
# myTableçš„å…§å®¹
output$myTable <- renderDataTable({
    # kwDF=kwDF;b="Air Force"
    b = branch_reactive()$b
    alias=EX()$alias
    kwDF = EX()$kwDF
    if(!is.null(kwDF)) {
      kwDF$Award.Title = str_replace_all(
      kwDF$Award.Title, regex(paste0('(',alias,')'), FALSE),
      paste0(ctag[2],'\\1</font></b>') )
    }
    # åˆ—å‡ºæ–‡ç« åˆ—è¡¨selectä»£è¡¨å¯ä»¥é»é¸
    datatable(
      kwDF %>% filter(Branch == b) %>% dplyr::select(Award.Title,Award.Year) %>% setNames(c("æ¨™é¡Œ","å¹´ä»½")),
      escape=F,rownames=F,extensions=c('Scroller','Select'),
      selection=list(mode='single', selected=c(1), target='row'),
      options=list(
      scrollY="750px",scrollX=F,paging=F,searching=F,ordering=F,
      select = list(style='single'),info=F
      )
    )
})
```


Column {data-width=50%}
-------------------------------------
###  {data-height=70%}
```{r}
RowSel =
 eventReactive( # to prevent race-around
  input$myTable_rows_selected, {input$myTable_rows_selected})
# æ‹¿åˆ°myTableé»é¸äº†å“ªä¸€å€‹row
renderDataTable({
  if(class(EX()) == 'list') {
    i = RowSel()
    b=branch_reactive()$b
    kwDF = EX()$kwDF %>% filter(Branch == b)
    kwDF = kwDF[i,]
    alias=EX()$alias
    kwDF$Abstract = str_replace_all(
      kwDF$Abstract, regex(paste0('(',alias,')'), FALSE),
      paste0(ctag[2],'\\1</font></b>') )
    
     datatable(
        kwDF[,'Abstract',drop=F],
        escape=F,rownames=F,colnames=c('è£œåŠ©æ¡ˆæ‘˜è¦å…§å®¹'),
        extensions=c('Scroller'),options=list(
          scrollY="350px",scrollX=F,paging=F,searching=F,ordering=F,info=F)
      )
  }
})
```


###  {data-height=30%}
```{r}
renderDataTable({
  i = RowSel()
  b=branch_reactive()$b
  kwDF = EX()$kwDF %>% filter(Branch == b)
  kwDF = kwDF[i,]
  datatable(
    kwDF[,c('Branch','Company','Award.Amount','Research.Keywords')] %>% t(),
    rownames = T,colnames=c('è£œåŠ©æ¡ˆç›¸é—œè³‡è¨Š'),escape=F,
    extensions=c('Scroller'),options=list(
          scrollY="350px",scrollX=F,paging=F,searching=F,ordering=F,info=F)
      )
})

```


